generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                   String             @id @default(cuid())
  studentId            String             @unique
  email                String             @unique
  name                 String
  faculty              String
  major                String
  year                 Int
  bio                  String?
  avatarUrl            String?
  rating               Float              @default(0)
  totalSales           Int                @default(0)
  totalPurchases       Int                @default(0)
  isVerified           Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  role                 String             @default("user")
  conversationsAsUser1 Conversation[]     @relation("User1Conversations")
  conversationsAsUser2 Conversation[]     @relation("User2Conversations")
  organizedEvents      Event[]            @relation("EventOrganizer")
  eventParticipations  EventParticipant[]
  eventReviews         EventReview[]
  foodItems            FoodItem[]
  foodOrders           FoodOrder[]
  foodReviews          FoodReview[]
  createdGroups        Group[]            @relation("CreatedGroups")
  groupMemberships     GroupMember[]      @relation("GroupMemberships")
  sentGroupMessages    GroupMessage[]     @relation("SentGroupMessages")
  marketplaceItems     MarketplaceItem[]
  receivedMessages     Message[]          @relation("ReceivedMessages")
  sentMessages         Message[]          @relation("SentMessages")
  notifications        Notification[]
  reviews              Review[]           @relation("ReviewAuthor")
  receivedReviews      Review[]           @relation("ReviewTarget")
  buyerTransactions    Transaction[]      @relation("BuyerTransactions")
  sellerTransactions   Transaction[]      @relation("SellerTransactions")
  studentSessions      TutoringSession[]  @relation("StudentSessions")
  tutoringSessions     TutoringSession[]  @relation("TutorSessions")
  userStats            UserStats?
  wishlistItems        WishlistItem[]
  withdrawals          Withdrawal[]
  clubMemberships      ClubMember[]

  @@index([studentId])
  @@index([email])
}

model MarketplaceItem {
  id            String         @id @default(cuid())
  title         String
  description   String
  price         Int
  category      String
  course        String
  faculty       String
  imageUrl      String?
  fileUrl       String?
  status        String         @default("available")
  rating        Float          @default(0)
  reviewCount   Int            @default(0)
  viewCount     Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  sellerId      String
  condition     String?        @default("Good")
  downloadCount Int            @default(0)
  fileName      String?
  fileSize      Int?
  fileType      String?
  thumbnailUrl  String?
  seller        User           @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  reviews       Review[]
  transactions  Transaction[]
  wishlistItems WishlistItem[]

  @@index([sellerId])
  @@index([category])
  @@index([faculty])
  @@index([status])
  @@index([createdAt])
}

model Conversation {
  id              String    @id @default(cuid())
  lastMessage     String?
  lastMessageTime DateTime  @default(now())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user1Id         String
  user2Id         String
  user1           User      @relation("User1Conversations", fields: [user1Id], references: [id], onDelete: Cascade)
  user2           User      @relation("User2Conversations", fields: [user2Id], references: [id], onDelete: Cascade)
  messages        Message[]

  @@unique([user1Id, user2Id])
  @@index([user1Id])
  @@index([user2Id])
}

model Message {
  id             String       @id @default(cuid())
  content        String
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())
  senderId       String
  receiverId     String
  conversationId String
  messageType    String       @default("text")
  orderData      Json?
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  receiver       User         @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  sender         User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([conversationId])
  @@index([createdAt])
}

model Group {
  id          String         @id @default(cuid())
  name        String
  description String?
  avatarUrl   String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  creatorId   String
  creator     User           @relation("CreatedGroups", fields: [creatorId], references: [id], onDelete: Cascade)
  members     GroupMember[]
  messages    GroupMessage[]

  @@index([creatorId])
  @@index([createdAt])
}

model GroupMember {
  id       String   @id @default(cuid())
  role     String   @default("member")
  joinedAt DateTime @default(now())
  groupId  String
  userId   String
  group    Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  user     User     @relation("GroupMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([userId])
}

model GroupMessage {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  groupId   String
  senderId  String
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  sender    User     @relation("SentGroupMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([groupId])
  @@index([senderId])
  @@index([createdAt])
}

model TutoringSession {
  id          String   @id @default(cuid())
  subject     String
  course      String
  description String
  price       Int
  duration    Int
  status      String   @default("pending")
  scheduledAt DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tutorId     String
  studentId   String
  student     User     @relation("StudentSessions", fields: [studentId], references: [id], onDelete: Cascade)
  tutor       User     @relation("TutorSessions", fields: [tutorId], references: [id], onDelete: Cascade)

  @@index([tutorId])
  @@index([studentId])
  @@index([status])
  @@index([scheduledAt])
}

model Review {
  id        String           @id @default(cuid())
  rating    Int
  comment   String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  authorId  String
  targetId  String
  itemId    String?
  author    User             @relation("ReviewAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  item      MarketplaceItem? @relation(fields: [itemId], references: [id], onDelete: Cascade)
  target    User             @relation("ReviewTarget", fields: [targetId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([targetId])
  @@index([itemId])
}

model Notification {
  id        String   @id @default(cuid())
  type      String
  title     String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model Transaction {
  id              String           @id @default(cuid())
  amount          Int
  status          String           @default("PENDING")
  paymentMethod   String?
  paymentProvider String?          @default("midtrans")
  transactionId   String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  buyerId         String
  itemId          String?
  fraudStatus     String?
  itemTitle       String
  itemType        String
  orderId         String           @unique
  snapToken       String?
  snapUrl         String?
  expiresAt       DateTime?
  sellerId        String?
  foodItemId      String?
  eventId         String?
  buyer           User             @relation("BuyerTransactions", fields: [buyerId], references: [id], onDelete: Cascade)
  foodItem        FoodItem?        @relation(fields: [foodItemId], references: [id], onDelete: Cascade)
  item            MarketplaceItem? @relation(fields: [itemId], references: [id], onDelete: Cascade)
  event           Event?           @relation(fields: [eventId], references: [id], onDelete: Cascade)
  seller          User?            @relation("SellerTransactions", fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([buyerId])
  @@index([sellerId])
  @@index([itemId])
  @@index([foodItemId])
  @@index([eventId])
  @@index([status])
  @@index([orderId])
  @@index([createdAt])
}

model UserStats {
  id                 String   @id @default(cuid())
  itemsSold          Int      @default(0)
  itemsBought        Int      @default(0)
  totalEarnings      Int      @default(0)
  totalSpent         Int      @default(0)
  messagesCount      Int      @default(0)
  tutoringSessions   Int      @default(0)
  reviewsGiven       Int      @default(0)
  reviewsReceived    Int      @default(0)
  updatedAt          DateTime @updatedAt
  userId             String   @unique
  availableBalance   Int      @default(0)
  pendingBalance     Int      @default(0)
  savedAccountName   String?
  savedAccountNumber String?
  savedBankName      String?
  savedPaymentMethod String?
  withdrawnBalance   Int      @default(0)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Withdrawal {
  id              String    @id @default(cuid())
  amount          Int
  status          String    @default("PENDING")
  paymentMethod   String    @default("GOPAY")
  accountNumber   String
  accountName     String
  bankName        String?
  processedBy     String?
  processedAt     DateTime?
  rejectionReason String?
  irisReferenceNo String?
  irisStatus      String?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model WishlistItem {
  id        String          @id @default(cuid())
  createdAt DateTime        @default(now())
  userId    String
  itemId    String
  item      MarketplaceItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemId])
  @@index([userId])
  @@index([itemId])
}

model FoodItem {
  id             String        @id @default(cuid())
  title          String
  description    String
  price          Int
  category       String
  foodType       String
  quantity       Int           @default(1)
  unit           String
  imageUrl       String?
  allergens      String[]
  ingredients    String?
  expiryDate     DateTime?
  pickupLocation String
  pickupTime     String
  isHalal        Boolean       @default(false)
  isVegan        Boolean       @default(false)
  isVegetarian   Boolean       @default(false)
  status         String        @default("available")
  rating         Float         @default(0)
  reviewCount    Int           @default(0)
  viewCount      Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  sellerId       String
  seller         User          @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  orders         FoodOrder[]
  reviews        FoodReview[]
  transactions   Transaction[]

  @@index([sellerId])
  @@index([category])
  @@index([status])
  @@index([createdAt])
}

model FoodOrder {
  id         String   @id @default(cuid())
  quantity   Int
  totalPrice Int
  pickupTime String
  status     String   @default("pending")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  foodItemId String
  buyerId    String
  buyer      User     @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  foodItem   FoodItem @relation(fields: [foodItemId], references: [id], onDelete: Cascade)

  @@index([foodItemId])
  @@index([buyerId])
  @@index([status])
  @@index([createdAt])
}

model FoodReview {
  id         String   @id @default(cuid())
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  foodItemId String
  userId     String
  foodItem   FoodItem @relation(fields: [foodItemId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([foodItemId])
  @@index([userId])
}

model Event {
  id                   String             @id @default(cuid())
  title                String
  description          String
  category             String
  eventType            String
  price                Int                @default(0)
  imageUrl             String?
  bannerUrl            String?
  location             String
  venue                String?
  isOnline             Boolean            @default(false)
  meetingLink          String?
  startDate            DateTime
  endDate              DateTime
  registrationDeadline DateTime?
  maxParticipants      Int?
  currentParticipants  Int                @default(0)
  tags                 String[]
  requirements         String?
  organizer            String
  contactEmail         String?
  contactPhone         String?
  status               String             @default("upcoming")
  isPublished          Boolean            @default(false)
  isFeatured           Boolean            @default(false)
  viewCount            Int                @default(0)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  organizerId          String
  organizerUser        User               @relation("EventOrganizer", fields: [organizerId], references: [id], onDelete: Cascade)
  participants         EventParticipant[]
  reviews              EventReview[]
  updates              EventUpdate[]
  transactions         Transaction[]

  @@index([organizerId])
  @@index([category])
  @@index([status])
  @@index([startDate])
  @@index([createdAt])
}

model EventParticipant {
  id            String    @id @default(cuid())
  status        String    @default("registered")
  registeredAt  DateTime  @default(now())
  attendedAt    DateTime?
  paymentStatus String?   @default("pending")
  transactionId String?
  eventId       String
  userId        String
  event         Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([eventId])
  @@index([userId])
  @@index([status])
}

model EventReview {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  eventId   String
  userId    String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([userId])
}

model EventUpdate {
  id        String   @id @default(cuid())
  title     String
  message   String
  createdAt DateTime @default(now())
  eventId   String
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([createdAt])
}

model Club {
  id          String       @id @default(cuid())
  name        String
  description String
  logoUrl     String?
  category    String
  memberCount Int          @default(0)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  members     ClubMember[]

  @@index([category])
  @@index([createdAt])
}

model ClubMember {
  id        String   @id @default(cuid())
  clubId    String
  userId    String
  joinedAt  DateTime @default(now())
  club      Club     @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@index([clubId])
  @@index([userId])
}
